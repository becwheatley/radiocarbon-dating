---
title: "Sampling bias in radiocarbon dating project: simulation study (no population change)"
author: "Rebecca Wheatley"
date: "13 May 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up

Load required packages:
```{r, message = FALSE, echo = TRUE}
library(rcarbon)
library(ggformula)
library(extraDistr)
library(EnvStats)
library(truncdist)
library(data.table)
library(tidyverse)
library(ggpubr)
```

Specify path for source functions:
```{r, message = FALSE, echo = TRUE}
source("C:/Users/Bec/Work/Projects/Radiocarbon dating/GitHub/Analysis/simulation_study-source.R")
```

## Simulating no change in population growth over time (with taphonomic loss)

Data for our analysis is simulated in two steps.  

1. Each site in our simulated data set (`no_sites`) has an occupation range: the minimum and maximum ages the site was occupied (in years BP). How these occupation ranges are generated depends on the underlying population trend (`pop_trend`) we aim to simulate.  
+ "no change" simulates a steady population over time (values drawn from a uniform distribution).  
+ "steady growth" simulates linear population growth (values drawn from an approximately linear distribution).  
+ "exponential growth" simulates exponential population growth (values drawn from an exponential distribution).  
+ "growth then decline" simulates an intial steady population growth followed by a population decrease (values drawn from a triangular distribution with the mode at the midpoint between the upper and lower `timeRange` bounds).   
(see `simulation_study-source.R` for specific implementation of each case)

2. Within this occupation range, each site has some evidence (`no_samples`) that our imaginary archaeologist can sample from. These samples are generated in one of two ways depending on whether we want to simulate taphonomic loss or not:  
+ `taph_loss` = FALSE; we do not wish to simulate taphonomic loss, so samples are pulled from a uniform distribution bounded by the site's occupation range.  
+ `taph_loss` = TRUE; we wish to simulate taphonomic loss, so samples are pulled from an exponential distribution with a rate of 0.04/500 (informed by our other study using dynamic occupancy modelling to tease apart population growth and taphonomic loss - more on this later) and bounded by the site's occupation range.  
These samples then form our full data set.

Set the parameters we want for our simulated data:
```{r, message = FALSE}
timeRange  = c(12000, 200)   ## for Holocene sites
no_sites   = 100             ## the number of sites we want in our simulated data set
no_samples = 20              ## the number of samples we want each site to have
pop_trend  = "no change"     ## the underlying population trend we want to mimic
taph_loss  = TRUE            ## will we simulate pull of the recent in our baseline data set?
```

Generate our complete simulated data set (we will be using this as our baseline data set and compare results using this data to results from various sub-samples):
```{r}
baseline.data <- get_available_evidence(timeRange = timeRange, no_sites = no_sites, no_samples = no_samples, 
                                        pop_trend = pop_trend, taph_loss = taph_loss)
glimpse(baseline.data)
```

We will run several sampling methods on this data set to investigate different potential biases in radiocarbon dating sampling. These sampling methods are:  
1. **Uniform**. For each site (or some % of sites), choose a number of samples (`sampling_effort`) from a uniform distribution  
2. **Singleton**. For each site (or some % of sites), choose one sample. There are three methods of choosing which sample to use:  
+ the most **ancient** sample  
+ the most **recent** sample  
+ a **random** sample  
3. **Bracketed**. For each site (or some % of sites), choose the most recent and the most ancient sample  

There are, therefore, two new parameters for subsampling the baseline data: `percent_sites` and `sampling_effort`. These determine the percent of sites we apply the sampling methods to and the number of samples we want to select if using a uniform sampling method.

```{r}
percent_sites   = 50   ## the number of sites we want to apply the sampling method across (the remainder will be 
                       ## exhaustively sampled)
sampling_effort = 5    ## the number of samples we want to take using the uniform sampling method
nsim            = 2   ## the number of replicates to make when sampling
```

Using these parameters, generate nsim replicates of the data using the sampling method specified:
```{r, message = FALSE}
sample.uniform           <- get_samples(evidence = baseline.data, 
                                        sampling_method = "uniform", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.singleton.ancient <- get_samples(evidence = baseline.data, 
                                        sampling_method = "singleton_ancient", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.singleton.recent  <- get_samples(evidence = baseline.data, 
                                        sampling_method = "singleton_recent", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.singleton.random  <- get_samples(evidence = baseline.data, 
                                        sampling_method = "singleton_random", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.bracketed         <- get_samples(evidence = baseline.data, 
                                        sampling_method = "bracketed", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)
```

Calibrate the baseline and sample data (using the `'rcarbon` package):
```{r, message = FALSE, results = 'hide', progress_bar = FALSE}
normalised      = TRUE ## are calibration curves (and, later, SPDs) normalised?
ncores          = 6    ## the number of threads to use when calibrating the radiocarbon dates

cal.baseline.data <- rcarbon::calibrate(x = baseline.data$age, 
                                        errors = baseline.data$error, 
                                        calCurves = 'shcal20', 
                                        normalised = normalised, 
                                        ncores = ncores)

cal.uniform           <- calibrate_samples(samples = sample.uniform, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.singleton.ancient <- calibrate_samples(samples = sample.singleton.ancient, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.singleton.recent  <- calibrate_samples(samples = sample.singleton.recent, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.singleton.random  <- calibrate_samples(samples = sample.singleton.random, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.bracketed         <- calibrate_samples(samples = sample.bracketed, 
                                           normalised = normalised, 
                                           ncores = ncores)
```

### Summed probability distributions (SPDs)

Calculate the summed probability distribution for each sample, and then compare the mean SPD over the samples to the baseline SPD:
```{r, message = FALSE,  results = 'hide', progress_bar = FALSE}
runm = 100 ## the running mean to use for the SPDs

spd.uniform           <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.uniform, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.singleton.ancient <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.singleton.ancient, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.singleton.recent  <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.singleton.recent, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.singleton.random  <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.singleton.random, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.bracketed         <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.bracketed, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)
```

Plot the resulting summed probability distributions:  
* dashed black line is the SPD for the full data set  
* solid coloured line is the median SPD for the sampled data set  
* ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE, message = TRUE}
# Uniform
u <- ggplot(NULL) +
     geom_ribbon(aes(x = spd.uniform$baseline$calBP, ymin = spd.uniform$envelope[[1]][,1], 
                  ymax = spd.uniform$envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
     geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$envelope[[1]][,2]), lwd = 1, color = "#66C2A5") +
     geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$baseline$PrDens), lwd = 1, colour = "black", 
               linetype = "dashed") +
     labs(x = "Years cal BP", y = "Probability") +
     scale_x_reverse(breaks = seq(12200, 200, by = -6000), limits = c(12200, 200)) +
     theme_bw()

# Singleton ancient
san <- ggplot(NULL) +
       geom_ribbon(aes(x = spd.singleton.ancient$baseline$calBP, ymin = spd.singleton.ancient$envelope[[1]][,1], 
                       ymax = spd.singleton.ancient$envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
       geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$envelope[[1]][,2]), lwd = 1, 
                 color = "#FC8D62") +
       geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$baseline$PrDens), lwd = 1, colour = "black", 
                 linetype = "dashed") +
       labs(x = "Years cal BP", y = "Probability") +
       scale_x_reverse(breaks = seq(12200, 200, by = -6000), limits = c(12200, 200)) +
       theme_bw()

# Singleton recent
sre <- ggplot(NULL) +
       geom_ribbon(aes(x = spd.singleton.recent$baseline$calBP, ymin = spd.singleton.recent$envelope[[1]][,1], 
                       ymax = spd.singleton.recent$envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
       geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$envelope[[1]][,2]), lwd = 1, color = "#8DA0CB") +
       geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$baseline$PrDens), lwd = 1, colour = "black", 
                 linetype = "dashed") +
       labs(x = "Years cal BP", y = "Probability") +
       scale_x_reverse(breaks = seq(12200, 200, by = -6000), limits = c(12200, 200)) +
       theme_bw()

# Singleton random
sra <- ggplot(NULL) +
       geom_ribbon(aes(x = spd.singleton.random$baseline$calBP, ymin = spd.singleton.random$envelope[[1]][,1], 
                       ymax = spd.singleton.random$envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
       geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$envelope[[1]][,2]), lwd = 1, color = "#E78AC3") +
       geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$baseline$PrDens), lwd = 1, colour = "black", 
                 linetype = "dashed") +
       labs(x = "Years cal BP", y = "Probability") +
       scale_x_reverse(breaks = seq(12200, 200, by = -6000), limits = c(12200, 200)) +
       theme_bw()

# Bracketed
b <- ggplot(NULL) +
     geom_ribbon(aes(x = spd.bracketed$baseline$calBP, ymin = spd.bracketed$envelope[[1]][,1], 
                     ymax = spd.bracketed$envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
     geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$envelope[[1]][,2]), lwd = 1, color = "#A6D854") +
     geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$baseline$PrDens), lwd = 1, colour = "black",   
               linetype = "dashed") +
     labs(x = "Years cal BP", y = "Probability") +
     scale_x_reverse(breaks = seq(12200, 200, by = -6000), limits = c(12200, 200)) +
     theme_bw()

# Multi-panelled plot
ggarrange(u, sre, san, sra, b,
          labels = c("Uniform", "Singleton recent", "Singleton ancient", "Singelton random", "Bracketed"),
          ncol = 2, nrow = 3)


# Combined
ggplot(NULL) +
  geom_ribbon(aes(x = spd.uniform$baseline$calBP, ymin = spd.uniform$envelope[[1]][,1], 
                  ymax = spd.uniform$envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_ribbon(aes(x = spd.singleton.ancient$baseline$calBP, ymin = spd.singleton.ancient$envelope[[1]][,1], 
                  ymax = spd.singleton.ancient$envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
   geom_ribbon(aes(x = spd.singleton.recent$baseline$calBP, ymin = spd.singleton.recent$envelope[[1]][,1], 
                  ymax = spd.singleton.recent$envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_ribbon(aes(x = spd.singleton.random$baseline$calBP, ymin = spd.singleton.random$envelope[[1]][,1], 
                  ymax = spd.singleton.random$envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_ribbon(aes(x = spd.bracketed$baseline$calBP, ymin = spd.bracketed$envelope[[1]][,1], 
                  ymax = spd.bracketed$envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$envelope[[1]][,2]), lwd = 1, color = "#66C2A5") +
  geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$envelope[[1]][,2]), lwd = 1, color = "#FC8D62") +
  geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$envelope[[1]][,2]), lwd = 1, color = "#8DA0CB") +
  geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$envelope[[1]][,2]), lwd = 1, color = "#E78AC3") +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$envelope[[1]][,2]), lwd = 1, color = "#A6D854") +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("All subsets combined") +
  scale_x_reverse(breaks = seq(12200, 200, by = -6000), limits = c(12200, 200)) +
  theme_bw()
```

### Frequency distributions of dates within time bins

Calculate the frequency distribution for each sample, and then compare the mean frequency distribution over the samples to the baseline frequency distribution:
```{r}
taphCorrect = TRUE    ## whether to taphonomically correct the open sites - not currently as haven't specified whether sites are open
correctForSite = FALSE ## per bin: number of sites with at least one date in them, or number of dates within the bin total
binSize = 100          ## the size of the bins to use (years) - use a bin size that actually fits the timeRange specified

# Get median bin age for x axis (same for all plots)
median.bin.age   <- seq(timeRange[2] + binSize/2, timeRange[1] - binSize/2, by = binSize)

fd.uniform           <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.uniform, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.uniform,
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect, 
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.ancient <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.ancient, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.ancient,
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect, 
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.recent  <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.recent, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.recent, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.random  <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.random, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.random, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.bracketed         <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.bracketed, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.bracketed, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)
```

Plot the resulting frequency distributions:  
* dashed black line is a smoothed spline of the frequency distribution for the full data set  
* solid coloured line is a smoothed spline of the median frequency distribution for the sampled data set  
* ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE}
# Get median bin age for x axis (same for all plots)
median.bin.age   <- seq(timeRange[2] + binSize/2, timeRange[1] - binSize/2, by = binSize)

# Uniform
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("5 uniformly selected samples from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton ancient
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most ancient sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton recent
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most recent sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton random
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("One random sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Bracketed
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only most ancient and most recent sample from 50% sites (bracketed)") +
  scale_x_reverse() +
  theme_bw()

# All
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("All sampling methods on same plot") +
  scale_x_reverse() +
  theme_bw()
```

### Frequency distributions of sites with dates within time bins

Calculate the frequency distribution for each sample, and then compare the mean frequency distribution over the samples to the baseline frequency distribution:
```{r}
taphCorrect = FALSE    ## whether to taphonomically correct the open sites - not currently as haven't specified whether sites are open
correctForSite = TRUE  ## per bin: number of sites with at least one date in them, or number of dates within the bin total
binSize = 100          ## the size of the bins to use (years) - use a bin size that actually fits the timeRange specified

fd.uniform.sites           <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.uniform, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.uniform,
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect, 
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.singleton.ancient.sites <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.singleton.ancient, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.singleton.ancient,
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect, 
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.singleton.recent.sites  <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.singleton.recent, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.singleton.recent, 
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect,
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.singleton.random.sites  <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.singleton.random, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.singleton.random, 
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect,
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.bracketed.sites         <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.bracketed, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.bracketed, 
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect,
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)
```

Plot the resulting frequency distributions:  
* dashed black line is a smoothed spline of the frequency distribution for the full data set  
* solid coloured line is a smoothed spline of the median frequency distribution for the sampled data set   
* ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE}
# Get median bin age for x axis (same for all plots)
median.bin.age   <- seq(timeRange[2] + binSize/2, timeRange[1] - binSize/2, by = binSize)

# Uniform
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform.sites$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("5 uniformly selected samples from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton ancient
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient.sites$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most ancient sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton recent
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent.sites$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most recent sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton random
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random.sites$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("One random sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Bracketed
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed.sites$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only most ancient and most recent sample from 50% sites (bracketed)") +
  scale_x_reverse() +
  theme_bw()

# All
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform.sites$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient.sites$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent.sites$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random.sites$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed.sites$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("All sampling methods on same plot") +
  scale_x_reverse() +
  theme_bw()
```

## Simulating no change in population growth over time (without taphonomic loss)

Set the parameters we want for our simulated data:
```{r, message = FALSE}
timeRange  = c(12000, 200) ## for Holocene sites
no_sites   = 100           ## the number of sites we want in our simulated data set
no_samples = 20            ## the number of samples we want each site to have
pop_trend  = "no change"    ## the underlying population trend we want to mimic
taph_loss  = FALSE          ## will we simulate pull of the recent in our baseline data set?
```

Generate our complete simulated data set (we will be using this as our baseline data set and compare results using this data to results from various sub-samples):
```{r}
baseline.data <- get_available_evidence(timeRange = timeRange, no_sites = no_sites, no_samples = no_samples, 
                                        pop_trend = pop_trend, taph_loss = taph_loss)
glimpse(baseline.data)
```

We will run several sampling methods on this data set to investigate different potential biases in radiocarbon dating sampling. These sampling methods are:  
1. **Uniform**. For each site (or some % of sites), choose a number of samples (`sampling_effort`) from a uniform distribution  
2. **Singleton**. For each site (or some % of sites), choose one sample. There are three methods of choosing which sample to use:  
+ the most **ancient** sample  
+ the most **recent** sample  
+ a **random** sample  
3. **Bracketed**. For each site (or some % of sites), choose the most recent and the most ancient sample  

There are, therefore, two new parameters for subsampling the baseline data: `percent_sites` and `sampling_effort`. These determine the percent of sites we apply the sampling methods to and the number of samples we want to select if using a uniform sampling method.

```{r}
percent_sites   = 50   ## the number of sites we want to apply the sampling method across (the remainder will be 
                       ## exhaustively sampled)
sampling_effort = 5    ## the number of samples we want to take using the uniform sampling method
nsim            = 2   ## the number of replicates to make when sampling
```

Using these parameters, generate nsim replicates of the data using the sampling method specified and calibrate:
```{r, message = FALSE}
sample.uniform           <- get_samples(evidence = baseline.data, 
                                        sampling_method = "uniform", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.singleton.ancient <- get_samples(evidence = baseline.data, 
                                        sampling_method = "singleton_ancient", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.singleton.recent  <- get_samples(evidence = baseline.data, 
                                        sampling_method = "singleton_recent", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.singleton.random  <- get_samples(evidence = baseline.data, 
                                        sampling_method = "singleton_random", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)

sample.bracketed         <- get_samples(evidence = baseline.data, 
                                        sampling_method = "bracketed", 
                                        sampling_effort = sampling_effort, 
                                        percent_sites = percent_sites, 
                                        nsim = nsim)
```

Calibrate the baseline and sample data (using the `'rcarbon` package):
```{r, message = FALSE, results = 'hide', progress_bar = FALSE}
normalised      = TRUE ## are calibration curves (and, later, SPDs) normalised?
ncores          = 6    ## the number of threads to use when calibrating the radiocarbon dates

cal.baseline.data <- rcarbon::calibrate(x = baseline.data$age, 
                                        errors = baseline.data$error, 
                                        calCurves = 'shcal20', 
                                        normalised = normalised, 
                                        ncores = ncores)

cal.uniform           <- calibrate_samples(samples = sample.uniform, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.singleton.ancient <- calibrate_samples(samples = sample.singleton.ancient, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.singleton.recent  <- calibrate_samples(samples = sample.singleton.recent, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.singleton.random  <- calibrate_samples(samples = sample.singleton.random, 
                                           normalised = normalised, 
                                           ncores = ncores)

cal.bracketed         <- calibrate_samples(samples = sample.bracketed, 
                                           normalised = normalised, 
                                           ncores = ncores)
```

### Summed probability distributions (SPDs)

Calculate the summed probability distribution for each sample, and then compare the mean SPD over the samples to the baseline SPD:
```{r, message = FALSE,  results = 'hide', progress_bar = FALSE}
runm = 100 ## the running mean to use for the SPDs

spd.uniform           <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.uniform, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.singleton.ancient <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.singleton.ancient, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.singleton.recent  <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.singleton.recent, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.singleton.random  <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.singleton.random, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)

spd.bracketed         <- compare_spds(calibrated_evidence = cal.baseline.data, 
                                      calibrated_samples = cal.bracketed, 
                                      timeRange = timeRange, 
                                      runm = runm, 
                                      normalised = normalised)
```

Plot the resulting summed probability distributions:  
* dashed black line is the SPD for the full data set  
* solid coloured line is the median SPD for the sampled data set  
* ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE, message = TRUE}
# Uniform
ggplot(NULL) +
  geom_ribbon(aes(x = spd.uniform$baseline$calBP, ymin = spd.uniform$envelope[[1]][,1], 
                  ymax = spd.uniform$envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$envelope[[1]][,2]), lwd = 1, color = "#66C2A5") +
  geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("5 uniformly selected samples from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Singleton ancient
ggplot(NULL) +
  geom_ribbon(aes(x = spd.singleton.ancient$baseline$calBP, ymin = spd.singleton.ancient$envelope[[1]][,1], 
                  ymax = spd.singleton.ancient$envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$envelope[[1]][,2]), lwd = 1, color = "#FC8D62") +
  geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("Only the most ancient sample from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Singleton recent
ggplot(NULL) +
  geom_ribbon(aes(x = spd.singleton.recent$baseline$calBP, ymin = spd.singleton.recent$envelope[[1]][,1], 
                  ymax = spd.singleton.recent$envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$envelope[[1]][,2]), lwd = 1, color = "#8DA0CB") +
  geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("Only the most recent sample from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Singleton random
ggplot(NULL) +
  geom_ribbon(aes(x = spd.singleton.random$baseline$calBP, ymin = spd.singleton.random$envelope[[1]][,1], 
                  ymax = spd.singleton.random$envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$envelope[[1]][,2]), lwd = 1, color = "#E78AC3") +
  geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("One random sample from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Bracketed
ggplot(NULL) +
  geom_ribbon(aes(x = spd.bracketed$baseline$calBP, ymin = spd.bracketed$envelope[[1]][,1], 
                  ymax = spd.bracketed$envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$envelope[[1]][,2]), lwd = 1, color = "#A6D854") +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("Only most ancient and most recent sample from 50% sites (bracketed)") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()


# Combined
ggplot(NULL) +
  geom_ribbon(aes(x = spd.uniform$baseline$calBP, ymin = spd.uniform$envelope[[1]][,1], 
                  ymax = spd.uniform$envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_ribbon(aes(x = spd.singleton.ancient$baseline$calBP, ymin = spd.singleton.ancient$envelope[[1]][,1], 
                  ymax = spd.singleton.ancient$envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
   geom_ribbon(aes(x = spd.singleton.recent$baseline$calBP, ymin = spd.singleton.recent$envelope[[1]][,1], 
                  ymax = spd.singleton.recent$envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_ribbon(aes(x = spd.singleton.random$baseline$calBP, ymin = spd.singleton.random$envelope[[1]][,1], 
                  ymax = spd.singleton.random$envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_ribbon(aes(x = spd.bracketed$baseline$calBP, ymin = spd.bracketed$envelope[[1]][,1], 
                  ymax = spd.bracketed$envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$envelope[[1]][,2]), lwd = 1, color = "#66C2A5") +
  geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$envelope[[1]][,2]), lwd = 1, color = "#FC8D62") +
  geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$envelope[[1]][,2]), lwd = 1, color = "#8DA0CB") +
  geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$envelope[[1]][,2]), lwd = 1, color = "#E78AC3") +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$envelope[[1]][,2]), lwd = 1, color = "#A6D854") +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("All subsets combined") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()
```

### Frequency distributions of dates within time bins

Calculate the frequency distribution for each sample, and then compare the mean frequency distribution over the samples to the baseline frequency distribution:
```{r}
taphCorrect = FALSE    ## whether to taphonomically correct the open sites - not currently as haven't specified whether sites are open
correctForSite = FALSE ## per bin: number of sites with at least one date in them, or number of dates within the bin total
binSize = 100          ## the size of the bins to use (years) - use a bin size that actually fits the timeRange specified

fd.uniform           <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.uniform, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.uniform,
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect, 
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.ancient <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.ancient, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.ancient,
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect, 
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.recent  <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.recent, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.recent, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.random  <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.random, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.random, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.bracketed         <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.bracketed, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.bracketed, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)
```

Plot the resulting frequency distributions:  
* dashed black line is a smoothed spline of the frequency distribution for the full data set  
* solid coloured line is a smoothed spline of the median frequency distribution for the sampled data set  
* ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE}
# Get median bin age for x axis (same for all plots)
median.bin.age   <- seq(timeRange[2] + binSize/2, timeRange[1] - binSize/2, by = binSize)

# Uniform
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("5 uniformly selected samples from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton ancient
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most ancient sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton recent
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most recent sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton random
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("One random sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Bracketed
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only most ancient and most recent sample from 50% sites (bracketed)") +
  scale_x_reverse() +
  theme_bw()

# All
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("All sampling methods on same plot") +
  scale_x_reverse() +
  theme_bw()
```

### Frequency distributions of sites with dates within time bins

Calculate the frequency distribution for each sample, and then compare the mean frequency distribution over the samples to the baseline frequency distribution:
```{r}
taphCorrect = FALSE    ## whether to taphonomically correct the open sites - not currently as haven't specified whether sites are open
correctForSite = TRUE  ## per bin: number of sites with at least one date in them, or number of dates within the bin total
binSize = 100          ## the size of the bins to use (years) - use a bin size that actually fits the timeRange specified

fd.uniform.sites           <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.uniform, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.uniform,
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect, 
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.singleton.ancient.sites <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.singleton.ancient, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.singleton.ancient,
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect, 
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.singleton.recent.sites  <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.singleton.recent, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.singleton.recent, 
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect,
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.singleton.random.sites  <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.singleton.random, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.singleton.random, 
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect,
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)

fd.bracketed.sites         <- compare_frequency_dists(evidence = baseline.data, 
                                                      samples = sample.bracketed, 
                                                      calibrated_evidence = cal.baseline.data,
                                                      calibrated_samples = cal.bracketed, 
                                                      timeRange = timeRange, 
                                                      taphCorrect = taphCorrect,
                                                      correctForSite = correctForSite, 
                                                      binSize = binSize)
```

Plot the resulting frequency distributions:  
* dashed black line is a smoothed spline of the frequency distribution for the full data set  
* solid coloured line is a smoothed spline of the median frequency distribution for the sampled data set  
* ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE}
# Get median bin age for x axis (same for all plots)
median.bin.age   <- seq(timeRange[2] + binSize/2, timeRange[1] - binSize/2, by = binSize)

# Uniform
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform.sites$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("5 uniformly selected samples from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton ancient
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient.sites$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most ancient sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton recent
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent.sites$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most recent sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton random
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random.sites$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("One random sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Bracketed
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed.sites$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only most ancient and most recent sample from 50% sites (bracketed)") +
  scale_x_reverse() +
  theme_bw()

# All
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform.sites$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient.sites$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent.sites$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random.sites$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed.sites$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed.sites$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 40) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed.sites$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 40) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("All sampling methods on same plot") +
  scale_x_reverse() +
  theme_bw()
```