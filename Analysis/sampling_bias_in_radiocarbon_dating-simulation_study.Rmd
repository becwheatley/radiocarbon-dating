---
title: "Sampling bias in radiocarbon dating project: simulation study"
author: "Rebecca Wheatley"
date: "3 May 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up

Load required packages:
```{r, message = FALSE, echo = TRUE}
library(rcarbon)
library(ggformula)
library(extraDistr)
library(truncdist)
library(data.table)
library(tidyverse)
library(RColorBrewer)
```

Specify path for source functions:
```{r, message = FALSE, echo = TRUE}
source("C:/Users/Bec/Work/Projects/Radiocarbon dating/GitHub/Analysis/simulation_study-source.R")
```

## Unbiased data with simulated taphonomic loss

Set the parameters we want for our simulated data:
```{r, message = FALSE}
timeRange  <- c(12000, 200) ## for Holocene sites
no_sites   <- 100           ## the number of sites we want in our simulated data set
no_samples <- 100           ## the number of samples we want each site to have
pull       <- TRUE          ## will we simulate pull of the recent in our baseline data set?
```

Generate our complete simulated data set (we will be using this as our baseline data set and compare results using this data to results from various sub-samples):
```{r}
baseline.data <- get_available_evidence(timeRange = timeRange, no_sites = no_sites, no_samples = no_samples, pull = pull)
glimpse(baseline.data)
```

We will run several sampling methods on this data set to investigate different potential biases in radiocarbon dating sampling. These sampling methods are:  
1. **Uniform**. For each site (or some % of sites), choose a number of samples (`sampling_effort`) from a uniform distribution  
2. **Singleton**. For each site (or some % of sites), choose one sample. There are three methods of choosing which sample to use:  
+ the most **ancient** sample  
+ the most **recent** sample  
+ a **random** sample  
3. **Bracketed**. For each site (or some % of sites), choose the most recent and the most ancient sample  

There are, therefore, two new parameters for subsampling the baseline data: `percent_sites` and `sampling_effort`. These determine the percent of sites we apply the sampling methods to and the number of samples we want to select if using a uniform sampling method.

```{r}
percent_sites   = 50   ## the number of sites we want to apply the sampling method across (the remainder will be exhaustively sampled)
sampling_effort = 10   ## the number of samples we want to take using the uniform sampling method
nsim            = 10    ## the number of replicates to make when sampling
```

Using these parameters, generate nsim replicates of the data using the sampling method specified and calibrate:
```{r}
sample.uniform           <- get_samples(evidence = baseline.data, sampling_method = "uniform", 
                                        sampling_effort = sampling_effort, percent_sites = percent_sites, nsim = nsim)
sample.singleton.ancient <- get_samples(evidence = baseline.data, sampling_method = "singleton_ancient", 
                                        sampling_effort = sampling_effort, percent_sites = percent_sites, nsim = nsim)
sample.singleton.recent  <- get_samples(evidence = baseline.data, sampling_method = "singleton_recent", 
                                        sampling_effort = sampling_effort, percent_sites = percent_sites, nsim = nsim)
sample.singleton.random  <- get_samples(evidence = baseline.data, sampling_method = "singleton_random", 
                                        sampling_effort = sampling_effort, percent_sites = percent_sites, nsim = nsim)
sample.bracketed         <- get_samples(evidence = baseline.data, sampling_method = "bracketed", 
                                        sampling_effort = sampling_effort, percent_sites = percent_sites, nsim = nsim)
```

Calibrate the baseline and sample data (using the `'rcarbon` package):
```{r, message = FALSE}
normalised      = TRUE ## are calibration curves (and, later, SPDs) normalised?
ncores          = 6    ## the number of threads to use when calibrating the radiocarbon dates
cal.baseline.data <- rcarbon::calibrate(x = baseline.data$age, errors = baseline.data$error, calCurves = 'shcal20', 
                                        normalised = normalised, ncores = ncores)
cal.uniform           <- calibrate_samples(samples = sample.uniform, normalised = normalised, ncores = ncores)
cal.singleton.ancient <- calibrate_samples(samples = sample.singleton.ancient, normalised = normalised, ncores = ncores)
cal.singleton.recent  <- calibrate_samples(samples = sample.singleton.recent, normalised = normalised, ncores = ncores)
cal.singleton.random  <- calibrate_samples(samples = sample.singleton.random, normalised = normalised, ncores = ncores)
cal.bracketed         <- calibrate_samples(samples = sample.bracketed, normalised = normalised, ncores = ncores)
```

Calculate the summed probability distribution for each sample, and then compare the mean SPD over the samples to the baseline SPD:
```{r, message = FALSE}
runm = 100 ## the running mean to use for the SPDs
spd.uniform           <- compare_spds(calibrated_evidence = cal.baseline.data, calibrated_samples = cal.uniform, 
                                      timeRange = timeRange, runm = runm, normalised = normalised)
spd.singleton.ancient <- compare_spds(calibrated_evidence = cal.baseline.data, calibrated_samples = cal.singleton.ancient, 
                                      timeRange = timeRange, runm = runm, normalised = normalised)
spd.singleton.recent  <- compare_spds(calibrated_evidence = cal.baseline.data, calibrated_samples = cal.singleton.recent, 
                                      timeRange = timeRange, runm = runm, normalised = normalised)
spd.singleton.random  <- compare_spds(calibrated_evidence = cal.baseline.data, calibrated_samples = cal.singleton.random, 
                                      timeRange = timeRange, runm = runm, normalised = normalised)
spd.bracketed         <- compare_spds(calibrated_evidence = cal.baseline.data, calibrated_samples = cal.bracketed, 
                                      timeRange = timeRange, runm = runm, normalised = normalised)
```

Get p-values:
```{r}
spd.uniform$pValueList
spd.singleton.ancient$pValueList
spd.singleton.recent$pValueList
spd.singleton.random$pValueList
spd.bracketed$pValueList
```

Plot the resulting summed probability distributions:
* dashed black line is the SPD for the full data set  
* solid coloured line is the median SPD for the sampled data set  
* ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE, message = TRUE}
display.brewer.all(n = 5, type = "all", select = NULL, colorblindFriendly = TRUE)
brewer.pal(5, "Set2") ## Set2 is colour-blind friendly according to RColourBrewer

# Uniform
ggplot(NULL) +
  geom_ribbon(aes(x = spd.uniform$baseline$calBP, ymin = spd.uniform$envelope[[1]][,1], 
                  ymax = spd.uniform$envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$envelope[[1]][,2]), lwd = 1, color = "#66C2A5") +
  geom_line(aes(x = spd.uniform$baseline$calBP, y = spd.uniform$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("10 uniformly selected samples from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Singleton ancient
ggplot(NULL) +
  geom_ribbon(aes(x = spd.singleton.ancient$baseline$calBP, ymin = spd.singleton.ancient$envelope[[1]][,1], 
                  ymax = spd.singleton.ancient$envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$envelope[[1]][,2]), lwd = 1, color = "#FC8D62") +
  geom_line(aes(x = spd.singleton.ancient$baseline$calBP, y = spd.singleton.ancient$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("Only the most ancient sample from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Singleton recent
ggplot(NULL) +
  geom_ribbon(aes(x = spd.singleton.recent$baseline$calBP, ymin = spd.singleton.recent$envelope[[1]][,1], 
                  ymax = spd.singleton.recent$envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$envelope[[1]][,2]), lwd = 1, color = "#8DA0CB") +
  geom_line(aes(x = spd.singleton.recent$baseline$calBP, y = spd.singleton.recent$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("Only the most recent sample from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Singleton random
ggplot(NULL) +
  geom_ribbon(aes(x = spd.singleton.random$baseline$calBP, ymin = spd.singleton.random$envelope[[1]][,1], 
                  ymax = spd.singleton.random$envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$envelope[[1]][,2]), lwd = 1, color = "#E78AC3") +
  geom_line(aes(x = spd.singleton.random$baseline$calBP, y = spd.singleton.random$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("One random sample from 50% sites") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()

# Bracketed
ggplot(NULL) +
  geom_ribbon(aes(x = spd.bracketed$baseline$calBP, ymin = spd.bracketed$envelope[[1]][,1], 
                  ymax = spd.bracketed$envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$envelope[[1]][,2]), lwd = 1, color = "#A6D854") +
  geom_line(aes(x = spd.bracketed$baseline$calBP, y = spd.bracketed$baseline$PrDens), lwd = 1, colour = "black", 
            linetype = "dashed") +
  labs(x = "Years cal BP", y = "Probability") +
  ggtitle("Only most ancient and most recent sample from 50% sites (bracketed)") +
  scale_x_reverse(limits=timeRange) +
  theme_bw()
```

Calculate the frequency distribution for each sample, and then compare the mean frequency distribution over the samples to the baseline frequency distribution:
```{r}
taphCorrect = FALSE   ## whether to taphonomically correct the open sites - not currently as haven't specified whether sites are open
correctForSite = TRUE ## per bin: number of sites with at least one date in them, or number of dates within the bin total
binSize = 100         ## the size of the bins to use (years) - use a bin size that actually fits the timeRange specified

fd.uniform           <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.uniform, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.uniform,
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect, 
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.ancient <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.ancient, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.ancient,
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect, 
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.recent  <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.recent, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.recent, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.singleton.random  <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.singleton.random, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.singleton.random, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)

fd.bracketed         <- compare_frequency_dists(evidence = baseline.data, 
                                                samples = sample.bracketed, 
                                                calibrated_evidence = cal.baseline.data,
                                                calibrated_samples = cal.bracketed, 
                                                timeRange = timeRange, 
                                                taphCorrect = taphCorrect,
                                                correctForSite = correctForSite, 
                                                binSize = binSize)
```

Plot the resulting frequency distributions:
* dashed black line is the frequency distribution for the full data set  
* solid green line is the median frequency distribution for the sampled data set  
* green ribbon is the 95% confidence interval for the sampled data set  
```{r, echo = FALSE}
# Get median bin age for x axis (same for all plots)
median.bin.age   <- seq(timeRange[2] + binSize/2, timeRange[1] - binSize/2, by = binSize)

# Uniform
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.uniform$standardised.envelope[[1]][,1], 
                  ymax = fd.uniform$standardised.envelope[[1]][,3]), fill = "#66C2A5", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#66C2A5", df = 25) +
  geom_spline(aes(x = median.bin.age, y = fd.uniform$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 25) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("10 uniformly selected samples from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton ancient
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.ancient$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.ancient$standardised.envelope[[1]][,3]), fill = "#FC8D62", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#FC8D62", df = 25) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.ancient$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 25) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most ancient sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton recent
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.recent$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.recent$standardised.envelope[[1]][,3]), fill = "#8DA0CB", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#8DA0CB", df = 25) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.recent$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 25) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only the most recent sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Singleton random
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.singleton.random$standardised.envelope[[1]][,1], 
                  ymax = fd.singleton.random$standardised.envelope[[1]][,3]), fill = "#E78AC3", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#E78AC3", df = 25) +
  geom_spline(aes(x = median.bin.age, y = fd.singleton.random$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 25) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("One random sample from 50% of sites") +
  scale_x_reverse() +
  theme_bw()

# Bracketed
ggplot(NULL) +
  geom_ribbon(aes(x = median.bin.age, ymin = fd.bracketed$standardised.envelope[[1]][,1], 
                  ymax = fd.bracketed$standardised.envelope[[1]][,3]), fill = "#A6D854", alpha = 0.3) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.envelope[[1]][,2]), lwd = 1, 
              colour = "#A6D854", df = 25) +
  geom_spline(aes(x = median.bin.age, y = fd.bracketed$standardised.baseline[,1]), lwd = 1, 
              colour = "black", linetype = "dashed", df = 25) +
  labs(x = "Years cal BP", y = "Standardised frequency (frequency/sum(frequency) for each sample)") +
  ggtitle("Only most ancient and most recent sample from 50% sites (bracketed)") +
  scale_x_reverse() +
  theme_bw()
```

